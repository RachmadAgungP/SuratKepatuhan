<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistem Surat Kepatuhan PDP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            primary: '#0ea5e9',
            accent: '#059669',
            ink: '#111827'
          }
        }
      }
    }
  </script>
  <style>
    @media print {
      @page { size: A4; margin: 18mm 18mm 20mm 18mm; }
      .no-print { display: none !important; }
      body { color: #000; }
      a[href]:after { content: ""; }
      .page { box-shadow: none !important; border: none !important; }
    }
  </style>
</head>
<body class="bg-slate-50 text-ink">
  <div class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
    <!-- Header -->
    <div class="no-print mb-6 flex items-start md:items-center gap-4 flex-col md:flex-row">
      <h1 class="text-2xl md:text-3xl font-bold">Sistem Pembuatan Surat Kepatuhan Perlindungan Data Pribadi</h1>
      <div class="text-sm text-slate-600">Asia/Jakarta â€” <span id="now"></span></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- FORM -->
      <section class="no-print bg-white border rounded-2xl shadow p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-4">Data Surat</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Nama Instansi</label>
            <input id="instansi" class="w-full rounded-lg border px-3 py-2" placeholder="Dinas Pertanian Kabupaten Gresik" />
          </div>
          <div>
            <label class="block text-sm mb-1">Unit Kerja</label>
            <input id="unitKerja" class="w-full rounded-lg border px-3 py-2" placeholder="Sekretariat / Subbag Perencanaan" />
          </div>
          <div>
            <label class="block text-sm mb-1">Nomor Surat</label>
            <input id="nomorSurat" class="w-full rounded-lg border px-3 py-2" placeholder="123/PK-PDP/2025" />
          </div>
          <div>
            <label class="block text-sm mb-1">Tanggal Surat</label>
            <input id="tanggalSurat" type="date" class="w-full rounded-lg border px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-1">Perihal</label>
            <input id="perihal" class="w-full rounded-lg border px-3 py-2" value="Pernyataan Kepatuhan Perlindungan Data Pribadi" />
          </div>
          <div>
            <label class="block text-sm mb-1">Lokasi/Kota</label>
            <input id="kota" class="w-full rounded-lg border px-3 py-2" placeholder="Gresik" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Alamat Kantor</label>
            <input id="alamat" class="w-full rounded-lg border px-3 py-2" placeholder="Jl. ... No. ..., Gresik, Jawa Timur" />
          </div>
        </div>

        <h2 class="text-lg font-semibold mt-6 mb-2">Data Pegawai</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Nama Pegawai</label>
            <input id="namaPegawai" class="w-full rounded-lg border px-3 py-2" placeholder="Rachmad Agung Pambudi" />
          </div>
          <div>
            <label class="block text-sm mb-1">NIP</label>
            <input id="nip" class="w-full rounded-lg border px-3 py-2" placeholder="19980406 2025 1 001" />
          </div>
          <div>
            <label class="block text-sm mb-1">Jabatan</label>
            <input id="jabatan" class="w-full rounded-lg border px-3 py-2" placeholder="Penata Kelola Sistem & TI" />
          </div>
          <div>
            <label class="block text-sm mb-1">Email Dinas</label>
            <input id="email" type="email" class="w-full rounded-lg border px-3 py-2" placeholder="nama@gresikkab.go.id" />
          </div>
        </div>

        <h2 class="text-lg font-semibold mt-6 mb-2">Berlaku & Dasar Hukum</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Mulai Berlaku</label>
            <input id="mulaiBerlaku" type="date" class="w-full rounded-lg border px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-1">Selesai Berlaku</label>
            <input id="selesaiBerlaku" type="date" class="w-full rounded-lg border px-3 py-2" />
          </div>
        </div>
        <div class="mt-3">
          <label class="block text-sm mb-1">Dasar Hukum (satu per baris)</label>
          <textarea id="dasarHukum" rows="3" class="w-full rounded-lg border px-3 py-2" placeholder="UU No. 27 Tahun 2022 tentang Pelindungan Data Pribadi&#10;PP/SPBE/Perkada terkait keamanan informasi"></textarea>
        </div>

        <h2 class="text-lg font-semibold mt-6 mb-2">Poin Kepatuhan</h2>
        <div id="poinContainer" class="grid grid-cols-1 gap-2">
          <!-- Diisi JS -->
        </div>
        <button id="tambahPoin" class="mt-2 text-sm px-3 py-1.5 rounded-lg border">+ Tambah Poin</button>

        <h2 class="text-lg font-semibold mt-6 mb-2">Pejabat Penandatangan</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Nama Pejabat</label>
            <input id="namaPejabat" class="w-full rounded-lg border px-3 py-2" placeholder="Nama Pejabat" />
          </div>
          <div>
            <label class="block text-sm mb-1">Jabatan Pejabat</label>
            <input id="jabatanPejabat" class="w-full rounded-lg border px-3 py-2" placeholder="Sekretaris Dinas / Kepala Bidang" />
          </div>
        </div>

        <div class="mt-6 flex flex-wrap gap-3">
          <button id="btnPreview" class="px-4 py-2 rounded-xl bg-primary text-white">Perbarui Preview</button>
          <button id="btnCopy" class="px-4 py-2 rounded-xl border">Salin HTML Surat</button>
          <button id="btnPrint" class="px-4 py-2 rounded-xl bg-accent text-white">Cetak / PDF</button>
          <button id="btnDownloadDoc" class="px-4 py-2 rounded-xl border">Unduh .DOC</button>
          <button id="btnReset" class="px-4 py-2 rounded-xl border border-red-400 text-red-600">Reset</button>
        </div>
        <p class="mt-3 text-xs text-slate-500">Data tersimpan otomatis di perangkat (localStorage). Gunakan Cetak untuk PDF.</p>
      </section>

      <!-- PREVIEW -->
      <section class="bg-white border rounded-2xl shadow p-4 md:p-6">
        <div id="doc" class="page mx-auto max-w-[794px] min-h-[1123px] p-8 md:p-10 border rounded-xl bg-white">
          <!-- Letter content will be injected here -->
        </div>
      </section>
    </div>
  </div>

  <script>
    // -------- Helpers
    const $ = (id) => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const fmtDateID = (iso) => {
      if (!iso) return '';
      const d = new Date(iso + 'T00:00:00');
      return d.toLocaleDateString('id-ID', { day:'2-digit', month:'long', year:'numeric' });
    };
    const nl2li = (text) => (text||'').split('\n').filter(Boolean).map(t=>`<li>${t.replaceAll('&','&amp;')}</li>`).join('');
    const esc = (s) => (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    // -------- Default points of compliance
    const defaultPoints = [
      "Menggunakan data pribadi hanya untuk tujuan layanan yang sah dan terverifikasi.",
      "Menjaga kerahasiaan kredensial, tidak membagikan kata sandi/akses ke pihak yang tidak berwenang.",
      "Menerapkan prinsip minimasi data: mengumpulkan data seperlunya dan menyimpan sesuai masa retensi.",
      "Tidak mengunduh/menyebarkan data pribadi pada perangkat/kanal tidak aman (termasuk media sosial).",
      "Melaporkan insiden kebocoran/insiden keamanan informasi kepada atasan dan Tim TIK maksimal 1x24 jam.",
      "Mematuhi kebijakan SPBE, SK Keamanan Informasi, dan SOP Pengelolaan Akses serta Backup."
    ];

    // -------- Populate points UI
    const poinContainer = $('poinContainer');
    function renderPoinInputs(points) {
      poinContainer.innerHTML = '';
      points.forEach((val, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'flex gap-2';
        wrap.innerHTML = `
          <input data-idx="${idx}" class="flex-1 rounded-lg border px-3 py-2 poin-item" value="${esc(val)}" />
          <button data-del="${idx}" class="px-3 py-2 rounded-lg border text-red-600">Hapus</button>
        `;
        poinContainer.appendChild(wrap);
      });
      // delete events
      poinContainer.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const i = Number(e.currentTarget.dataset.del);
          const arr = getPoinValues().filter((_,k)=>k!==i);
          renderPoinInputs(arr);
          saveForm();
        });
      });
      // input autosave
      poinContainer.querySelectorAll('.poin-item').forEach(inp=>{
        inp.addEventListener('input', saveForm);
      });
    }

    function getPoinValues() {
      return Array.from(poinContainer.querySelectorAll('.poin-item')).map(i=>i.value.trim()).filter(Boolean);
    }

    // -------- Form state (autosave)
    const fields = [
      'instansi','unitKerja','nomorSurat','tanggalSurat','perihal','kota','alamat',
      'namaPegawai','nip','jabatan','email',
      'mulaiBerlaku','selesaiBerlaku','dasarHukum',
      'namaPejabat','jabatanPejabat'
    ];
    function loadForm() {
      const raw = localStorage.getItem('pdp_surat_form');
      let state = {};
      if (raw) {
        try { state = JSON.parse(raw); } catch {}
      }
      fields.forEach(f=>{
        if (state[f]) $(f).value = state[f];
      });
      if (!state.nomorSurat) $('nomorSurat').value = genNomorSurat();
      if (!state.tanggalSurat) $('tanggalSurat').value = todayISO();
      if (!state.mulaiBerlaku) $('mulaiBerlaku').value = todayISO();
      if (!state.selesaiBerlaku) {
        const d = new Date(); d.setFullYear(d.getFullYear()+1);
        $('selesaiBerlaku').value = d.toISOString().slice(0,10);
      }
      renderPoinInputs(state.poin || defaultPoints);
      if (!state.dasarHukum) {
        $('dasarHukum').value = "Undang-Undang Nomor 27 Tahun 2022 tentang Pelindungan Data Pribadi\nKebijakan SPBE dan Keamanan Informasi Pemerintah Daerah\nSOP Pengelolaan Akses, Pencadangan, dan Insiden Keamanan";
      }
    }
    function saveForm() {
      const state = {};
      fields.forEach(f=> state[f] = $(f).value || '');
      state.poin = getPoinValues();
      localStorage.setItem('pdp_surat_form', JSON.stringify(state));
    }
    fields.forEach(f => {
      document.addEventListener('input', (e) => {
        if (e.target && e.target.id === f) saveForm();
      }, true);
    });

    // -------- Doc ID & nomor surat
    function genDocID() {
      const t = Date.now().toString(36);
      const r = Math.random().toString(36).slice(2,7);
      return `PDP-${t}-${r}`.toUpperCase();
    }
    function genNomorSurat() {
      const y = new Date().getFullYear();
      const seq = String(Math.floor(Math.random()*900)+100);
      return `${seq}/PK-PDP/${y}`;
    }

    // -------- Render letter
    function renderLetter() {
      const v = {};
      fields.forEach(f=> v[f] = ($(f).value||'').trim());
      const points = getPoinValues();
      const dasar = $('dasarHukum').value || '';
      const docId = (localStorage.getItem('pdp_doc_id')) || genDocID();
      localStorage.setItem('pdp_doc_id', docId);

      const header = `
        <div class="text-center border-b pb-3">
          <div class="text-base">${esc(v.instansi) || 'INSTANSI PEMERINTAH'}</div>
          <div class="font-semibold text-lg">${esc(v.unitKerja) || 'UNIT KERJA'}</div>
          <div class="text-sm">${esc(v.alamat) || '-'}</div>
        </div>
      `;
      const title = `
        <div class="mt-4 text-center">
          <div class="uppercase font-bold tracking-wide">SURAT PERNYATAAN KEPA- TUHAN</div>
          <div class="uppercase font-bold tracking-wide">PERLINDUNGAN DATA PRIBADI</div>
          <div class="mt-1 text-sm">Nomor: ${esc(v.nomorSurat) || genNomorSurat()}</div>
          <div class="mt-0.5 text-xs text-slate-500">ID Dokumen: ${docId}</div>
        </div>
      `;
      const pembuka = `
        <div class="mt-6 text-sm leading-relaxed">
          Pada hari ini, ${new Date().toLocaleDateString('id-ID',{weekday:'long'})}, tanggal ${fmtDateID(v.tanggalSurat) || fmtDateID(todayISO())}, bertempat di ${esc(v.kota) || '-'}, yang bertanda tangan di bawah ini:
        </div>
        <table class="mt-3 w-full text-sm">
          <tr><td class="align-top w-40">Nama</td><td class="align-top">: ${esc(v.namaPegawai) || '-'}</td></tr>
          <tr><td class="align-top">NIP</td><td class="align-top">: ${esc(v.nip) || '-'}</td></tr>
          <tr><td class="align-top">Jabatan</td><td class="align-top">: ${esc(v.jabatan) || '-'}</td></tr>
          <tr><td class="align-top">Email Dinas</td><td class="align-top">: ${esc(v.email) || '-'}</td></tr>
          <tr><td class="align-top">Unit Kerja</td><td class="align-top">: ${esc(v.unitKerja) || '-'}</td></tr>
        </table>
      `;
      const isi = `
        <div class="mt-4 text-sm leading-relaxed">
          Menyatakan dengan sebenar-benarnya bahwa saya akan <span class="font-semibold">mematuhi ketentuan Pelindungan Data Pribadi (PDP)</span> sesuai peraturan perundang-undangan dan kebijakan internal, selama periode
          <span class="font-semibold">${fmtDateID(v.mulaiBerlaku)} s.d. ${fmtDateID(v.selesaiBerlaku)}</span>, dengan ketentuan berikut:
        </div>
        <ol class="mt-3 text-sm leading-relaxed list-decimal ml-5">
          ${points.map(p=>`<li>${esc(p)}</li>`).join('')}
        </ol>
      `;
      const dasarHukum = dasar.trim() ? `
        <div class="mt-4 text-sm">
          <span class="font-semibold">Dasar Hukum:</span>
          <ul class="list-disc ml-5 mt-1">
            ${nl2li(dasar)}
          </ul>
        </div>
      ` : '';

      const penutup = `
        <div class="mt-4 text-sm leading-relaxed">
          Demikian surat pernyataan ini dibuat untuk dipergunakan sebagaimana mestinya. Apabila di kemudian hari terdapat pelanggaran, saya bersedia dikenakan sanksi sesuai ketentuan yang berlaku.
        </div>
      `;

      const ttd = `
        <div class="mt-8 grid grid-cols-2 gap-6">
          <div class="text-sm">
            <div>Mengetahui,</div>
            <div>${esc(v.jabatanPejabat) || 'Pejabat Berwenang'}</div>
            <div class="h-16"></div>
            <div class="font-semibold underline underline-offset-4">${esc(v.namaPejabat) || '(Nama Pejabat)'}</div>
          </div>
          <div class="text-sm text-right">
            <div>${esc(v.kota) || '-'}, ${fmtDateID(v.tanggalSurat) || fmtDateID(todayISO())}</div>
            <div>Yang Menyatakan,</div>
            <div class="h-16"></div>
            <div class="font-semibold underline underline-offset-4">${esc(v.namaPegawai) || '(Nama Pegawai)'}</div>
            <div>NIP. ${esc(v.nip) || '-'}</div>
          </div>
        </div>
      `;

      $('doc').innerHTML = `
        ${header}
        ${title}
        <div class="mt-4 text-sm"><span class="font-semibold">Perihal:</span> ${esc(v.perihal) || '-'}</div>
        ${pembuka}
        ${isi}
        ${dasarHukum}
        ${penutup}
        ${ttd}
        <div class="mt-6 border-t pt-2 text-[11px] text-slate-500">
          Catatan: Surat ini dihasilkan secara elektronik melalui Sistem Kepatuhan PDP. Valid tanpa tanda tangan basah selama terverifikasi oleh unit kerja terkait.
        </div>
      `;
    }

    // -------- Download as .DOC (HTML-in-DOC wrapper)
    function downloadDoc(filename='Surat_Kepatuhan_PDP.doc') {
      const content = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset="utf-8"><title>Surat Kepatuhan PDP</title></head>
        <body>${$('doc').innerHTML}</body></html>`;
      const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
    }

    // -------- Events
    $('tambahPoin').addEventListener('click', () => {
      const arr = getPoinValues();
      arr.push('Poin kepatuhan baru...');
      renderPoinInputs(arr);
      saveForm();
    });
    $('btnPreview').addEventListener('click', renderLetter);
    $('btnCopy').addEventListener('click', async () => {
      const html = $('doc').innerHTML;
      try {
        await navigator.clipboard.writeText(html);
        alert('HTML surat telah disalin ke clipboard.');
      } catch {
        alert('Gagal menyalin. Pilih teks secara manual lalu salin.');
      }
    });
    $('btnPrint').addEventListener('click', () => {
      renderLetter();
      window.print();
    });
    $('btnDownloadDoc').addEventListener('click', () => {
      renderLetter();
      const nomor = $('nomorSurat').value || 'PDP';
      downloadDoc(`Surat_Kepatuhan_${nomor.replace(/\W+/g,'_')}.doc`);
    });
    $('btnReset').addEventListener('click', () => {
      if (!confirm('Hapus semua data tersimpan?')) return;
      localStorage.removeItem('pdp_surat_form');
      localStorage.removeItem('pdp_doc_id');
      location.reload();
    });

    // -------- Init
    document.addEventListener('DOMContentLoaded', () => {
      loadForm();
      renderLetter();
      $('now').textContent = new Date().toLocaleString('id-ID', { dateStyle:'full', timeStyle:'short' });
    });
  </script>
</body>
</html>
